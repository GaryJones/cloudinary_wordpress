<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Source: php/class-settings.php - Cloudinary Docs</title>

	<script src="scripts/prettify/prettify.js"></script>
	<script src="scripts/prettify/lang-css.js"></script>
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
	<link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link
			href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap"
			rel="stylesheet">
</head>

<body>

<div id="main">

	
	<h1 class="page-title">Source: php/class-settings.php</h1>
	

	



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Settings class for Cloudinary.
 *
 * @package Cloudinary
 */

namespace Cloudinary;

use Cloudinary\Settings\Setting;
use WP_Screen;

/**
 * Settings Class.
 */
class Settings {

	/**
	 * The single instance of the class.
	 *
	 * @var Settings
	 */
	protected static $instance = null;
	/**
	 * The setting to test.
	 *
	 * @var Setting[]
	 */
	protected $settings;

	/**
	 * List of Page handles.
	 *
	 * @var array
	 */
	public $handles = array();

	/**
	 * Holds the current active setting.
	 *
	 * @var Setting
	 */
	protected $current_setting;

	/**
	 * Holds the current Page.
	 *
	 * @var Setting
	 */
	protected $current_page;

	/**
	 * Holds the current tab.
	 *
	 * @var Setting
	 */
	protected $current_tab;

	/**
	 * Option name for settings based internal data.
	 *
	 * @var string
	 */
	const SETTINGS_DATA = '_settings_version';

	/**
	 * Initiate the settings object.
	 */
	protected function __construct() {
		add_action( 'admin_init', array( $this, 'register_wordpress_settings' ) );
		add_action( 'admin_menu', array( $this, 'build_menus' ) );
	}

	/**
	 * Check settings version to allow settings to update or upgrade.
	 *
	 * @param string $slug The slug for the settings set to check.
	 */
	protected static function check_version( $slug ) {
		$key              = '_' . $slug . self::SETTINGS_DATA;
		$settings_version = get_option( $key, 2.4 );
		$plugin_version   = get_plugin_instance()->version;
		if ( version_compare( $settings_version, $plugin_version, '&lt;' ) ) {
			// Allow for updating.
			do_action( "{$slug}_settings_upgrade", $settings_version, $plugin_version );
			// Update version.
			update_option( $key, $plugin_version );
		}
	}

	/**
	 * Register the page.
	 */
	public function build_menus() {
		foreach ( $this->settings as $setting ) {
			$this->register_admin( $setting );
		}
	}

	/**
	 * Register the page.
	 *
	 * @param Setting $setting The settings to create pages.
	 */
	public function register_admin( $setting ) {

		$render_function = array( $this, 'render' );

		// Setup the main page.
		$page_handle                   = add_menu_page(
			$setting->get_param( 'page_title' ),
			$setting->get_param( 'menu_title' ),
			$setting->get_param( 'capability' ),
			$setting->get_slug(),
			$render_function,
			$setting->get_param( 'icon' )
		);
		$this->handles[ $page_handle ] = $setting;
		$setting->set_param( 'page_handle', $page_handle );

		add_action( "load-{$page_handle}", array( $this, 'set_active_setting' ) );
		// Setup the Child page handles.
		foreach ( $setting->get_settings() as $sub_setting ) {
			/**
			 * Filter enabled setting.
			 *
			 * @hook    cloudinary_settings_enabled_{$sub_setting->get_slug()}
			 * @default true
			 *
			 * @param $true {bool} Is enabled.
			 *
			 * @return {bool}
			 */
			if ( 'page' !== $sub_setting->get_param( 'type' ) || ! apply_filters( "cloudinary_settings_enabled_{$sub_setting->get_slug()}", true ) ) {
				continue;
			}
			$sub_setting->set_param( 'page_header', $setting->get_param( 'page_header' ) );
			$sub_setting->set_param( 'page_footer', $setting->get_param( 'page_footer' ) );
			$capability                    = $sub_setting->get_param( 'capability', $setting->get_param( 'capability' ) );
			$page_handle                   = add_submenu_page(
				$setting->get_slug(),
				$sub_setting->get_param( 'page_title', $setting->get_param( 'page_title' ) ),
				$sub_setting->get_param( 'menu_title', $sub_setting->get_param( 'page_title' ) ),
				$capability,
				$sub_setting->get_slug(),
				$render_function,
				$sub_setting->get_param( 'position' )
			);
			$this->handles[ $page_handle ] = $sub_setting;
			$sub_setting->set_param( 'page_handle', $page_handle );

			add_action( "load-{$page_handle}", array( $this, 'set_active_setting' ) );
		}
	}

	/**
	 * Render a page.
	 */
	public function render() {
		// Enqueue Cloudinary.
		get_plugin_instance()->enqueue_assets();
		if ( $this->current_page->has_param( 'page_footer' ) ) {
			add_action( 'admin_footer', array( $this, 'render_footer' ) );
		}
		echo $this->current_page->get_component()->render(); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}

	/**
	 * Set the current active settings and tabs.
	 */
	public function set_active_setting() {
		$this->current_page = $this->get_active_page();
		$this->current_page->set_param( 'is_active', true );
		$this->current_setting = $this->current_page->get_root_setting();
		$this->current_setting->set_param( 'active_setting', $this->current_page );
		// Setup default tab.
		if ( $this->current_page->has_parent() &amp;&amp; $this->current_page->has_settings() ) {
			$settings          = $this->current_page->get_settings();
			$this->current_tab = array_shift( $settings );
		}

		$active_setting = filter_input( INPUT_GET, 'tab', FILTER_SANITIZE_STRING );
		if ( is_null( $active_setting ) ) {
			$active_setting = filter_input( INPUT_POST, 'tab', FILTER_SANITIZE_STRING );
		}
		if ( ! is_null( $active_setting ) &amp;&amp; $this->current_page->setting_exists( $active_setting ) ) {
			$this->current_tab = $this->current_page->get_setting( $active_setting );
		}

		// Setup current tab.
		if ( $this->current_tab &amp;&amp; $this->current_page !== $this->current_tab ) {
			$this->current_tab->set_param( 'is_active', true );
			$this->current_page->set_param( 'active_tab', $this->current_tab );
		}

	}

	/**
	 * Get the currently active page.
	 *
	 * @return Setting
	 */
	public function get_active_page() {
		$screen = get_current_screen();
		$page   = $this->settings;
		if ( $screen instanceof WP_Screen &amp;&amp; isset( $this->handles[ $screen->id ] ) ) {
			$page = $this->handles[ $screen->id ];
		}

		return $page;
	}

	/**
	 * Render the footer in admin page.
	 */
	public function render_footer() {
		echo $this->get_active_page()->get_param( 'page_footer' )->get_component()->render(); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}

	/**
	 * Register a setting.
	 *
	 * @param string $slug   The new setting slug.
	 * @param array  $params The setting parameters.
	 *
	 * @return Setting
	 */
	protected function register_setting( $slug, $params = array() ) {

		// Create new setting instance.
		$setting = new Setting( $slug, $params );

		// Register internals.
		$this->settings[ $slug ] = $setting;

		return $setting;
	}

	/**
	 * Register settings with WordPress.
	 */
	public function register_wordpress_settings() {

		foreach ( $this->settings as $setting ) {
			$setting->register_settings();
		}
	}

	/**
	 * Create a new setting on the Settings object.
	 *
	 * @param string $slug   The setting slug.
	 * @param array  $params The settings params.
	 *
	 * @return Setting
	 */
	public static function create_setting( $slug, $params = array() ) {
		if ( is_null( self::$instance ) ) {
			self::$instance = new self();
		}
		$params['option_name'] = $slug; // Root option.
		$params['type']        = 'page';
		$params['priority']    = 0;

		return self::$instance->register_setting( $slug, $params );
	}

	/**
	 * Initialise the registered settings by loading the data and registering the settings with WordPress.
	 *
	 * @param string $slug The setting slug to initialise.
	 */
	public static function init_setting( $slug ) {
		if ( ! is_null( self::$instance ) &amp;&amp; ! empty( self::$instance->settings[ $slug ] ) ) {
			self::check_version( $slug );
			$settings = self::$instance->settings[ $slug ];
			$settings->setup_component();
		}
	}
}
</code></pre>
        </article>
    </section>




</div>

<nav>
	<h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="cloudinary_id.html">cloudinary_id</a></li><li><a href="cloudinary_init_delivery.html">cloudinary_init_delivery</a></li><li><a href="cloudinary_queue_action.html">cloudinary_queue_action</a></li><li><a href="cloudinary_register_sync_types.html">cloudinary_register_sync_types</a></li><li><a href="cloudinary_string_replace.html">cloudinary_string_replace</a></li><li><a href="cloudinary_version_upgrade.html">cloudinary_version_upgrade</a></li></ul><h3>Filters</h3><ul><li><a href="cloudinary_admin_footer.html">cloudinary_admin_footer</a></li><li><a href="cloudinary_admin_header.html">cloudinary_admin_header</a></li><li><a href="cloudinary_admin_images_tab_global_transformations.html">cloudinary_admin_images_tab_global_transformations</a></li><li><a href="cloudinary_admin_pages.html">cloudinary_admin_pages</a></li><li><a href="cloudinary_admin_video_tab_global_transformations.html">cloudinary_admin_video_tab_global_transformations</a></li><li><a href="cloudinary_api_rest_endpoints.html">cloudinary_api_rest_endpoints</a></li><li><a href="cloudinary_apply_default_transformations.html">cloudinary_apply_default_transformations</a></li><li><a href="cloudinary_autosync_threads.html">cloudinary_autosync_threads</a></li><li><a href="cloudinary_beta.html">cloudinary_beta</a></li><li><a href="cloudinary_bypass_cache.html">cloudinary_bypass_cache</a></li><li><a href="cloudinary_can_sync_asset.html">cloudinary_can_sync_asset</a></li><li><a href="cloudinary_context_options.html">cloudinary_context_options</a></li><li><a href="cloudinary_convert_media_types.html">cloudinary_convert_media_types</a></li><li><a href="cloudinary_converted_url.html">cloudinary_converted_url</a></li><li><a href="cloudinary_cron_frequency.html">cloudinary_cron_frequency</a></li><li><a href="cloudinary_cron_start_offset.html">cloudinary_cron_start_offset</a></li><li><a href="cloudinary_current_post_id.html">cloudinary_current_post_id</a></li><li><a href="cloudinary_default_freeform_transformations_%257B$type%257D.html">cloudinary_default_freeform_transformations_{$type}</a></li><li><a href="cloudinary_default_qf_transformations_%257B$type%257D.html">cloudinary_default_qf_transformations_{$type}</a></li><li><a href="cloudinary_default_transformations.html">cloudinary_default_transformations</a></li><li><a href="cloudinary_doing_upload.html">cloudinary_doing_upload</a></li><li><a href="cloudinary_filter_out_local.html">cloudinary_filter_out_local</a></li><li><a href="cloudinary_gallery_config.html">cloudinary_gallery_config</a></li><li><a href="cloudinary_gallery_html_container.html">cloudinary_gallery_html_container</a></li><li><a href="cloudinary_get_setting_params.html">cloudinary_get_setting_params</a></li><li><a href="cloudinary_get_signature.html">cloudinary_get_signature</a></li><li><a href="cloudinary_init_settings.html">cloudinary_init_settings</a></li><li><a href="cloudinary_is_folder_synced.html">cloudinary_is_folder_synced</a></li><li><a href="cloudinary_media_status.html">cloudinary_media_status</a></li><li><a href="cloudinary_media_types.html">cloudinary_media_types</a></li><li><a href="cloudinary_migrate_legacy_meta.html">cloudinary_migrate_legacy_meta</a></li><li><a href="cloudinary_on_demand_sync_limit.html">cloudinary_on_demand_sync_limit</a></li><li><a href="cloudinary_plugin_asset_cache_filters.html">cloudinary_plugin_asset_cache_filters</a></li><li><a href="cloudinary_plugin_asset_cache_inline_types.html">cloudinary_plugin_asset_cache_inline_types</a></li><li><a href="cloudinary_pre_image_tag.html">cloudinary_pre_image_tag</a></li><li><a href="cloudinary_prepare_size.html">cloudinary_prepare_size</a></li><li><a href="cloudinary_preview_types.html">cloudinary_preview_types</a></li><li><a href="cloudinary_queue_threads.html">cloudinary_queue_threads</a></li><li><a href="cloudinary_resource_type.html">cloudinary_resource_type</a></li><li><a href="cloudinary_setting_get_value.html">cloudinary_setting_get_value</a></li><li><a href="cloudinary_settings_enabled_%257B$sub_setting-_get_slug()%257D.html">cloudinary_settings_enabled_{$sub_setting->get_slug()}</a></li><li><a href="cloudinary_settings_save_setting.html">cloudinary_settings_save_setting</a></li><li><a href="cloudinary_settings_save_setting_%257B$slug%257D.html">cloudinary_settings_save_setting_{$slug}</a></li><li><a href="cloudinary_setup_component_parts.html">cloudinary_setup_component_parts</a></li><li><a href="cloudinary_sync_base.html">cloudinary_sync_base</a></li><li><a href="cloudinary_sync_base_struct.html">cloudinary_sync_base_struct</a></li><li><a href="cloudinary_syncable_delivery_types.html">cloudinary_syncable_delivery_types</a></li><li><a href="cloudinary_transformations.html">cloudinary_transformations</a></li><li><a href="cloudinary_upload_options.html">cloudinary_upload_options</a></li><li><a href="cloudinary_validate_cloudinary_id.html">cloudinary_validate_cloudinary_id</a></li></ul>
</nav>

<br class="clear">

<footer>
	<a href="https://cloudinary.com/" target="_blank" rel="noopener noreferrer">Cloudinary</a> |
	<a href="https://github.com/cloudinary/cloudinary_wordpress/" target="_blank" rel="noopener noreferrer">Cloudinary
		on GitHub</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
